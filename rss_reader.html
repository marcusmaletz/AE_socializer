<script>
    class RSSReaderPro {
        constructor() {
            // DOM-Elemente abrufen
            this.feedNameInput = document.getElementById('feedName');
            this.feedUrlInput = document.getElementById('feedUrl');
            this.addFeedBtn = document.getElementById('addFeedBtn');
            this.savedFeedsList = document.getElementById('savedFeedsList');
            this.contentArea = document.getElementById('contentArea');
            this.feedCountSpan = document.getElementById('feedCount');
            this.refreshAllBtn = document.getElementById('refreshAllBtn');
            this.clearAllBtn = document.getElementById('clearAllBtn');

            // Initialisierung
            this.feeds = [];
            this.currentFeedId = null;

            // Events binden und Feeds laden
            this.bindEvents();
            this.loadSavedFeeds(); // L√§dt Feeds aus dem LocalStorage
        }

        bindEvents() {
            // Event f√ºr den "Hinzuf√ºgen"-Button
            this.addFeedBtn.addEventListener('click', () => this.addFeed());

            // Events f√ºr die Eingabefelder (Enter-Taste)
            this.feedUrlInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.addFeed();
            });
            this.feedNameInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.addFeed();
            });

            // Events f√ºr die allgemeinen Verwaltungs-Buttons
            this.refreshAllBtn.addEventListener('click', () => this.refreshAllFeeds());
            this.clearAllBtn.addEventListener('click', () => this.clearAllFeeds());
        }

        // ==================================================================
        // CORE LOGIC: Hinzuf√ºgen, L√∂schen, Laden und Speichern von Feeds
        // ==================================================================

        generateId() {
            // Erzeugt eine eindeutige ID f√ºr jeden Feed
            return 'feed_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        async addFeed() {
            const name = this.feedNameInput.value.trim();
            const url = this.feedUrlInput.value.trim();

            if (!name || !url) {
                alert('Bitte geben Sie sowohl einen Namen als auch eine URL ein.');
                return;
            }

            if (this.feeds.some(feed => feed.url === url)) {
                alert('Dieser Feed ist bereits gespeichert.');
                return;
            }

            const newFeed = {
                id: this.generateId(),
                name: name,
                url: url,
                articles: [],
                lastUpdated: null,
                error: null
            };

            this.feeds.push(newFeed);
            this.saveFeeds();
            this.renderSavedFeeds();

            // Eingabefelder leeren
            this.feedNameInput.value = '';
            this.feedUrlInput.value = '';

            // Neuen Feed direkt laden und anzeigen
            this.showLoading();
            await this.loadFeed(newFeed.id);
            this.selectFeed(newFeed.id);
        }

        deleteFeed(feedId) {
            if (confirm('M√∂chten Sie diesen Feed wirklich l√∂schen?')) {
                this.feeds = this.feeds.filter(feed => feed.id !== feedId);
                this.saveFeeds();
                this.renderSavedFeeds();

                // Wenn der gel√∂schte Feed der aktuell angezeigte war, Willkommensbildschirm zeigen
                if (this.currentFeedId === feedId) {
                    this.currentFeedId = null;
                    this.showWelcome();
                }
            }
        }

        clearAllFeeds() {
            if (confirm('M√∂chten Sie wirklich alle Feeds l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
                this.feeds = [];
                this.currentFeedId = null;
                this.saveFeeds();
                this.renderSavedFeeds();
                this.showWelcome();
            }
        }
        
        // HIER WAR EIN FEHLER: Funktion fehlte
        saveFeeds() {
            // Speichert das 'feeds'-Array als JSON-String im LocalStorage
            localStorage.setItem('rssFeeds', JSON.stringify(this.feeds));
        }

        // HIER WAR EIN FEHLER: Funktion fehlte
        loadSavedFeeds() {
            // L√§dt die Feeds aus dem LocalStorage
            const savedFeeds = localStorage.getItem('rssFeeds');
            if (savedFeeds) {
                this.feeds = JSON.parse(savedFeeds);
            }
            // Nach dem Laden die Liste in der Sidebar rendern
            this.renderSavedFeeds();
        }

        async loadFeed(feedId) {
            const feed = this.feeds.find(f => f.id === feedId);
            if (!feed) return;
            
            // Setzt den Feed-Zustand zur√ºck vor dem Laden
            feed.error = null;

            try {
                // Ein kostenloser Proxy, um CORS-Probleme zu umgehen
                const proxyUrl = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feed.url)}`;
                const response = await fetch(proxyUrl);
                
                if (!response.ok) {
                    throw new Error(`Netzwerkantwort war nicht ok: Status ${response.status}`);
                }

                const data = await response.json();
                
                if (data.status !== 'ok') {
                    throw new Error(data.message || 'Die RSS-Daten konnten nicht verarbeitet werden.');
                }
                
                // Feed-Daten aktualisieren
                feed.articles = data.items || [];
                feed.lastUpdated = new Date().toISOString(); // Speichert Datum als ISO-String
                feed.feedTitle = data.feed?.title || feed.name;

            } catch (error) {
                console.error(`Fehler beim Laden des Feeds "${feed.name}":`, error);
                feed.error = error.message;
                feed.articles = []; // Bei Fehler Artikelliste leeren
            }

            this.saveFeeds(); // Nach jedem Ladevorgang speichern
        }

        async refreshAllFeeds() {
            this.refreshAllBtn.disabled = true;
            this.refreshAllBtn.textContent = 'L√§dt...';

            // Alle Ladeoperationen parallel ausf√ºhren
            const promises = this.feeds.map(feed => this.loadFeed(feed.id));
            await Promise.all(promises);

            this.refreshAllBtn.disabled = false;
            this.refreshAllBtn.textContent = 'Alle aktualisieren';
            
            this.renderSavedFeeds();

            // Den aktuell ausgew√§hlten Feed neu anzeigen, falls einer aktiv ist
            if (this.currentFeedId) {
                this.displayFeed(this.currentFeedId);
            }
        }

        selectFeed(feedId) {
            this.currentFeedId = feedId;
            this.displayFeed(feedId);
            this.renderSavedFeeds(); // Ruft render auf, um den 'active' Status zu aktualisieren
        }
        
        // ==================================================================
        // UI RENDERING: Logik zur Darstellung der Inhalte
        // ==================================================================

        // HIER WAR EIN FEHLER: Funktion war unvollst√§ndig
        renderSavedFeeds() {
            this.feedCountSpan.textContent = `(${this.feeds.length})`;

            if (this.feeds.length === 0) {
                this.savedFeedsList.innerHTML = `
                    <div class="no-feeds-message">
                        Noch keine Feeds gespeichert
                    </div>`;
                return;
            }

            // Bestehenden Inhalt leeren
            this.savedFeedsList.innerHTML = '';

            // F√ºr jeden Feed ein HTML-Element erstellen
            this.feeds.forEach(feed => {
                const isActive = feed.id === this.currentFeedId;
                const item = document.createElement('div');
                item.className = `feed-item ${isActive ? 'active' : ''}`;
                item.innerHTML = `
                    <div class="feed-item-header">
                        <div class="feed-item-title">${feed.name}</div>
                        <div class="feed-item-actions">
                            <button class="delete-btn" title="L√∂schen">üóëÔ∏è</button>
                        </div>
                    </div>
                    <div class="feed-item-url">${feed.url}</div>
                    <div class="feed-item-count">${feed.articles ? feed.articles.length : 0} Artikel</div>
                `;

                // Event-Listener f√ºr das ganze Element (zum Anzeigen der Artikel)
                item.addEventListener('click', (e) => {
                    // Verhindern, dass der Klick auf den Button auch den Feed ausw√§hlt
                    if (!e.target.classList.contains('delete-btn')) {
                        this.selectFeed(feed.id);
                    }
                });
                
                // Event-Listener nur f√ºr den L√∂schen-Button
                item.querySelector('.delete-btn').addEventListener('click', (e) => {
                    e.stopPropagation(); // Verhindert, dass das 'item' Klick-Event auch ausgel√∂st wird
                    this.deleteFeed(feed.id);
                });

                this.savedFeedsList.appendChild(item);
            });
        }
        
        displayFeed(feedId) {
            const feed = this.feeds.find(f => f.id === feedId);
            if (!feed) return;

            if (feed.error) {
                this.contentArea.innerHTML = `
                    <div class="error">
                        <strong>Fehler beim Laden von "${feed.name}":</strong><br>
                        ${feed.error}
                    </div>`;
                return;
            }

            if (!feed.articles || feed.articles.length === 0) {
                this.contentArea.innerHTML = `
                    <div class="welcome">
                        <h3>Keine Artikel gefunden</h3>
                        <p>Der Feed "${feed.name}" enth√§lt aktuell keine Artikel.</p>
                    </div>`;
                return;
            }

            const lastUpdated = feed.lastUpdated ? 
                new Date(feed.lastUpdated).toLocaleString('de-DE') : 'Nie';

            const articlesHTML = feed.articles.map(item => {
                const pubDate = item.pubDate ? new Date(item.pubDate).toLocaleDateString('de-DE') : 'Unbekanntes Datum';
                const description = item.description ? 
                    item.description.replace(/<[^>]*>/g, '').substring(0, 200) + '...' : 
                    'Keine Beschreibung verf√ºgbar.';

                return `
                    <article class="article">
                        <div class="article-content">
                            <h3><a href="${item.link}" target="_blank" rel="noopener noreferrer">${item.title || 'Ohne Titel'}</a></h3>
                            <div class="article-meta">${pubDate} | ${feed.feedTitle || feed.name}</div>
                            <div class="article-description">${description}</div>
                            <a href="${item.link}" class="article-link" target="_blank" rel="noopener noreferrer">Artikel lesen ‚Üí</a>
                        </div>
                    </article>`;
            }).join('');

            this.contentArea.innerHTML = `
                <div class="articles-header">
                    <div class="articles-title">${feed.feedTitle || feed.name}</div>
                    <div class="articles-count">${feed.articles.length} Artikel</div>
                </div>
                <div class="last-updated">Zuletzt aktualisiert: ${lastUpdated}</div>
                ${articlesHTML}`;
        }

        showLoading() {
            this.contentArea.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>RSS-Feed wird geladen...</p>
                </div>`;
        }
        
        showWelcome() {
            this.contentArea.innerHTML = `
                <div class="welcome">
                    <h3>Willkommen beim RSS-Reader Pro</h3>
                    <p>F√ºgen Sie Ihre ersten RSS-Feeds √ºber die Seitenleiste hinzu, um zu beginnen.</p>
                    <p>Ihre Feeds werden automatisch in Ihrem Browser gespeichert.</p>
                </div>`;
        }
    }

    // Die Anwendung starten, sobald das DOM geladen ist
    document.addEventListener('DOMContentLoaded', () => {
        new RSSReaderPro();
    });
</script>
